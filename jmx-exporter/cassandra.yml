# Connects to Cassandra's JMX port exposed within the Docker network.
# Credentials are required because LOCAL_JMX=no enables CassandraLoginModule.
# https://github.com/apache/cassandra/blob/trunk/conf/cassandra-env.sh
hostPort: cassandra:7199
username: cassandra
password: cassandra
rules:
  # ClientRequest latency metrics: p50, p75, p95, p99, Mean (microseconds)
  # Pattern based on https://github.com/oleg-glushak/cassandra-prometheus-jmx
  - pattern: 'org.apache.cassandra.metrics<type=ClientRequest, scope=(Read|Write|RangeSlice|CASRead|CASWrite), name=Latency><>(50thPercentile|75thPercentile|95thPercentile|99thPercentile|Mean|Count)'
    name: cassandra_client_request_latency_$2
    labels:
      operation: $1
    type: GAUGE

  # ClientRequest throughput: total count for calculating RPS
  - pattern: 'org.apache.cassandra.metrics<type=ClientRequest, scope=(Read|Write|RangeSlice|CASRead|CASWrite), name=TotalLatency><>Count'
    name: cassandra_client_request_total
    labels:
      operation: $1
    type: COUNTER

  # Cache hit rate: KeyCache and RowCache
  - pattern: 'org.apache.cassandra.metrics<type=Cache, scope=(KeyCache|RowCache), name=HitRate><>Value'
    name: cassandra_cache_hit_rate
    labels:
      cache: $1
    type: GAUGE

  # Cache requests and hits for calculating hit rate
  - pattern: 'org.apache.cassandra.metrics<type=Cache, scope=(KeyCache|RowCache), name=(Requests|Hits)><>Count'
    name: cassandra_cache_$2_total
    labels:
      cache: $1
    type: COUNTER

  # ClientRequest error counters: timeouts, failures, and unavailable exceptions
  - pattern: 'org.apache.cassandra.metrics<type=ClientRequest, scope=(Read|Write|RangeSlice|CASRead|CASWrite), name=(Timeouts|Failures|Unavailables)><>Count'
    name: cassandra_client_request_errors_total
    labels:
      operation: $1
      error_type: $2
    type: COUNTER
