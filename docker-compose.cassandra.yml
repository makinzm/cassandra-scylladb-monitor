services:
  cassandra:
    image: cassandra:5
    ports:
      - "9042:9042"
    environment:
      # Allow JMX connections from other containers; required for the jmx-exporter sidecar.
      # https://github.com/apache/cassandra/blob/trunk/conf/cassandra-env.sh
      LOCAL_JMX: "no"
      # Environment variables are expanded in conf/cassandra-env.sh to set for avoiding docker 137 OOM
      # https://github.com/apache/cassandra/blob/940739a4889794a5f198731b152c70e86bc95976/conf/cassandra-env.sh
      MAX_HEAP_SIZE: 1G
      HEAP_NEWSIZE: 256M
    # Copies jmxremote.password into the container with mode 400 at startup.
    # The JVM rejects the file if it is world-readable.
    # https://docs.oracle.com/en/java/javase/17/management/monitoring-and-management-using-jmx-technology.html
    entrypoint:
      - /bin/bash
      - -c
      - |
        install -m 400 /tmp/jmxremote.password /etc/cassandra/jmxremote.password
        exec docker-entrypoint.sh cassandra -f
    volumes:
      - cassandra-data:/var/lib/cassandra
      - ./jmx-exporter/jmxremote.password:/tmp/jmxremote.password:ro
    healthcheck:
      test: ["CMD-SHELL", "cqlsh -e 'describe keyspaces' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 3G
  jmx-exporter:
    image: bitnami/jmx-exporter:latest
    ports:
      - "7070:7070"
    volumes:
      - ./jmx-exporter/cassandra.yml:/etc/jmx-exporter/cassandra.yml:ro
    command: ["7070", "/etc/jmx-exporter/cassandra.yml"]
    depends_on:
      cassandra:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
volumes:
  cassandra-data:
    driver: local
    # Named volumes have no portable size cap in Docker Compose.
    # To limit disk usage, mount this volume on a dedicated partition
    # or apply filesystem-level quotas on the host.